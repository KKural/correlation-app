<!DOCTYPE html>
<html>
<head><title>Full Data Test</title></head>
<body>
<pre id="output"></pre>
<script src="https://kkural.github.io/correlation-app/index.html"></script>
<script>
// Copy the SeededRandom class and test it
class SeededRandom {
    constructor(seed) {
        this.seed = seed >>> 0;
        this.mt = new Array(624);
        this.mti = 625;
        this.init(this.seed);
    }

    init(seed) {
        this.mt[0] = seed >>> 0;
        for (let i = 1; i < 624; i++) {
            const s = this.mt[i - 1] ^ (this.mt[i - 1] >>> 30);
            this.mt[i] = (((((s & 0xffff0000) >>> 16) * 1812433253) << 16) +
                (s & 0x0000ffff) * 1812433253 + i) >>> 0;
        }
        this.mti = 624;
    }

    next() {
        let y;
        const mag01 = [0x0, 0x9908b0df];

        if (this.mti >= 624) {
            let kk;
            for (kk = 0; kk < 624 - 397; kk++) {
                y = (this.mt[kk] & 0x80000000) | (this.mt[kk + 1] & 0x7fffffff);
                this.mt[kk] = this.mt[kk + 397] ^ (y >>> 1) ^ mag01[y & 0x1];
            }
            for (; kk < 624 - 1; kk++) {
                y = (this.mt[kk] & 0x80000000) | (this.mt[kk + 1] & 0x7fffffff);
                this.mt[kk] = this.mt[kk + (397 - 624)] ^ (y >>> 1) ^ mag01[y & 0x1];
            }
            y = (this.mt[623] & 0x80000000) | (this.mt[0] & 0x7fffffff);
            this.mt[623] = this.mt[396] ^ (y >>> 1) ^ mag01[y & 0x1];
            this.mti = 0;
        }

        y = this.mt[this.mti++];
        y ^= (y >>> 11);
        y ^= (y << 7) & 0x9d2c5680;
        y ^= (y << 15) & 0xefc60000;
        y ^= (y >>> 18);

        return (y >>> 0) / 4294967296;
    }

    normal(mean = 0, sd = 1) {
        const u1 = this.next();
        const u2 = this.next();
        const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        return mean + z0 * sd;
    }
}

function round4dp(val) {
    return Math.round(val * 10000) / 10000;
}

function round2dp(val) {
    return Math.round(val * 100) / 100;
}

const rng = new SeededRandom(123);
const n = 10;
const r = -0.45;

// Step 1: Generate latent variables
const Xz = [];
const eps = [];
for (let i = 0; i < n; i++) {
    Xz.push(rng.normal(0, 1));
}
for (let i = 0; i < n; i++) {
    eps.push(rng.normal(0, 1));
}

const Yz = [];
for (let i = 0; i < n; i++) {
    Yz.push(r * Xz[i] + Math.sqrt(Math.max(0, 1 - r * r)) * eps[i]);
}

let output = 'Xz: ' + Xz.map(v => v.toFixed(7)).join(' ') + '\n';
output += 'eps: ' + eps.map(v => v.toFixed(7)).join(' ') + '\n';
output += 'Yz: ' + Yz.map(v => v.toFixed(7)).join(' ') + '\n\n';

// Step 2: Base centers/scales
let x_center = 50, x_scale = 20;
let y_center = 20, y_scale = 8;

output += `Base x_center: ${x_center} x_scale: ${x_scale}\n`;
output += `Base y_center: ${y_center} y_scale: ${y_scale}\n\n`;

// Step 3: Add variability
const adj1 = rng.next() * 16 - 8;
const adj2 = rng.next() * 0.6 + 0.8;
const adj3 = rng.next() * 16 - 8;
const adj4 = rng.next() * 0.6 + 0.8;

x_center = x_center + adj1;
x_scale = x_scale * adj2;
y_center = y_center + adj3;
y_scale = y_scale * adj4;

output += `Adjustments: ${adj1.toFixed(6)}, ${adj2.toFixed(7)}, ${adj3.toFixed(6)}, ${adj4.toFixed(7)}\n`;
output += `After variability:\n`;
output += `x_center: ${x_center} x_scale: ${x_scale}\n`;
output += `y_center: ${y_center} y_scale: ${y_scale}\n\n`;

// Step 4: Scale
function scaleArray(z) {
    const mean = z.reduce((a, b) => a + b, 0) / z.length;
    const variance = z.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (z.length - 1);
    const sd = Math.sqrt(variance);
    return z.map(v => (v - mean) / sd);
}

const Xz_scaled = scaleArray(Xz);
const Yz_scaled = scaleArray(Yz);

output += 'Xz_scaled: ' + Xz_scaled.map(v => v.toFixed(7)).join(' ') + '\n';
output += 'Yz_scaled: ' + Yz_scaled.map(v => v.toFixed(7)).join(' ') + '\n\n';

const Xv = Xz_scaled.map(v => round4dp(x_center + x_scale * v));
const Yv = Yz_scaled.map(v => round4dp(y_center + y_scale * v));

output += 'Xv (before clamp): ' + Xv.join(' ') + '\n';
output += 'Yv (before clamp): ' + Yv.join(' ') + '\n\n';

// Step 5: Clamp
for (let i = 0; i < n; i++) {
    Xv[i] = Math.max(0, Math.min(100, Xv[i]));
    Yv[i] = Math.max(0, Yv[i]);
}

output += 'Final Xv: ' + Xv.join(' ') + '\n';
output += 'Final Yv: ' + Yv.join(' ') + '\n\n';

output += 'Display (2 decimals):\n';
for (let i = 0; i < n; i++) {
    output += `Buurt ${i+1}: ${round2dp(Xv[i])}, ${round2dp(Yv[i])}\n`;
}

document.getElementById('output').textContent = output;
</script>
</body>
</html>
