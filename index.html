<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correlatie Oefening - Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(180deg, #F6FAFF 0%, #F9F7FF 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #3F51B5;
            font-weight: 800;
            margin-bottom: 30px;
            text-align: center;
        }

        .card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .muted {
            color: #666;
            margin-bottom: 15px;
        }

        .accent {
            background: #E3F2FD;
            border-left: 4px solid #42A5F5;
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #42A5F5;
        }

        input.valid {
            border: 2px solid #00C853 !important;
            background: #e8f5e9;
        }

        input.invalid {
            border: 2px solid #D50000 !important;
            background: #ffebee;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th,
        td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        th {
            background: #f5f5f5;
            font-weight: 700;
            color: #333;
        }

        .feedback {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .feedback.ok {
            background: #e8f5e9;
            color: #0E7C7B;
            border-left: 4px solid #00C853;
        }

        .feedback.err {
            background: #ffebee;
            color: #B00020;
            border-left: 4px solid #D50000;
        }

        .traffic {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .light {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #BDBDBD;
            transition: background 0.2s;
        }

        .hidden {
            display: none;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Correlatie Oefening - Prototype</h1>

        <!-- Scenario Card -->
        <div class="card">
            <h2>Scenario & Dataset</h2>
            <p class="muted">Kies een scenario en genereer een dataset om te oefenen met correlatie berekeningen.</p>

            <div class="controls">
                <div>
                    <label for="scenario">Scenario</label>
                    <select id="scenario">
                        <option value="crime_program">Criminaliteitspreventie</option>
                        <option value="hotspots">Hot-spot Politiestrategie</option>
                        <option value="fear_disorder">Angst & Wanorde</option>
                    </select>
                </div>

                <div>
                    <label for="n">Steekproefgrootte (N)</label>
                    <input type="number" id="n" min="5" max="20" value="10">
                </div>

                <div>
                    <label for="seed">Dataset Code (optioneel)</label>
                    <input type="number" id="seed" placeholder="bijv. 12345">
                </div>
            </div>

            <button class="btn-primary" onclick="generateData()">Genereer Dataset</button>

            <div id="seedEcho" class="accent hidden" style="margin-top: 15px;">
                <strong>Dataset code:</strong> <span id="seedValue"></span>
            </div>
        </div>

        <!-- Vignette Card -->
        <div id="vignetteCard" class="card hidden">
            <h2>Taak & Context</h2>
            <div id="vignetteText"></div>
        </div>

        <!-- Data Display Card -->
        <div id="dataCard" class="card hidden">
            <h2>Deel I — Dataset</h2>
            <p class="muted">Bekijk uw data voordat u begint met berekeningen.</p>
            <table id="dataTable"></table>
        </div>

        <!-- Step 1: Means Card -->
        <div id="step1Card" class="card hidden">
            <h2>Deel II — Stap 1: Rekenkundige Gemiddelden</h2>
            <p class="muted">Bereken het gemiddelde van X en Y. Rond af op 4 decimalen.</p>

            <div class="accent">
                <strong>Variabelen:</strong><br>
                <strong>X:</strong> <span id="varXLabel"></span><br>
                <strong>Y:</strong> <span id="varYLabel"></span>
            </div>

            <div class="grid-2" style="margin: 20px 0;">
                <div>
                    <label for="meanX">X̄ (Gemiddelde van X)</label>
                    <input type="number" id="meanX" step="0.0001" placeholder="0.0000" oninput="checkMeans()">
                </div>
                <div>
                    <label for="meanY">Ȳ (Gemiddelde van Y)</label>
                    <input type="number" id="meanY" step="0.0001" placeholder="0.0000" oninput="checkMeans()">
                </div>
            </div>

            <div class="traffic">
                <div class="light" id="lightMeanX"></div>
                <div class="light" id="lightMeanY"></div>
            </div>

            <div id="meansFeedback"></div>

            <button class="btn-secondary" onclick="proceedToStep2()" style="margin-top: 15px;">
                Ga verder naar Stap 2 →
            </button>
        </div>

        <!-- Step 2: Deviations Card -->
        <div id="step2Card" class="card hidden">
            <h2>Deel III — Stap 2: Afwijkingen & Kwadraten</h2>
            <p class="muted">Bereken voor elk datapunt de afwijking van het gemiddelde en het kwadraat daarvan.</p>

            <table id="deviationsTable"></table>

            <div class="traffic" id="deviationsLights"></div>

            <div id="deviationsFeedback"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // DATA & STATE MANAGEMENT
        // ============================================================

        let state = {
            scenario: null,
            n: 10,
            seed: null,
            data: [],
            varX: '',
            varY: '',
            trueValues: {
                meanX: 0,
                meanY: 0,
                deviations: []
            }
        };

        // Scenario definitions (simplified)
        const scenarios = {
            crime_program: {
                name: "Criminaliteitspreventie Programma",
                varX: "ProgrammaBlootstelling",
                varY: "InbraakCijfer",
                varXLabel: "Programmablootstelling (%)",
                varYLabel: "Inbraakcijfer (per 1000)",
                vignette: "Een gemeente voert een criminaliteitspreventie programma uit. U analyseert of huishoudens die bereikt werden door het programma (X) lagere inbraakcijfers vertonen (Y).",
                concepts: [
                    "<b>Inbraakcijfer:</b> aantal inbraken per 1.000 inwoners.",
                    "<b>Programmablootstelling:</b> percentage huishoudens bereikt door preventie."
                ],
                correlation: -0.7  // Expected correlation
            },
            hotspots: {
                name: "Hot-spot Politiestrategie",
                varX: "VoetPatrouilleUren",
                varY: "MeldingenAanPolitie",
                varXLabel: "Voetpatrouille Uren",
                varYLabel: "Meldingen aan Politie",
                vignette: "Politie voert gerichte patrouilles uit in hot-spots. U onderzoekt of meer patrouille-uren (X) leiden tot meer meldingen (Y).",
                concepts: [
                    "<b>Hot-spot politiestrategie:</b> gerichte patrouille in gebieden met verhoogde criminaliteit.",
                    "<b>Meldingen aan politie:</b> aantal verzoeken om politie-interventie."
                ],
                correlation: 0.6
            },
            fear_disorder: {
                name: "Angst & Wanorde",
                varX: "WanordeIndex",
                varY: "AngstScore",
                varXLabel: "Wanorde Index",
                varYLabel: "Angst Score",
                vignette: "U onderzoekt of wijken met meer wanorde (graffiti, zwerfvuil) hogere angst voor criminaliteit vertonen.",
                concepts: [
                    "<b>Angst voor criminaliteit:</b> bezorgdheid om slachtoffer te worden.",
                    "<b>Wanorde:</b> signalen zoals zwerfvuil, graffiti, overlastgevend gedrag."
                ],
                correlation: 0.75
            }
        };

        // ============================================================
        // SEEDED RANDOM NUMBER GENERATOR
        // ============================================================

        class SeededRandom {
            constructor(seed) {
                this.seed = seed || Math.floor(Math.random() * 999999);
            }

            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }

            normal(mean = 0, sd = 1) {
                // Box-Muller transform
                const u1 = this.next();
                const u2 = this.next();
                const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                return mean + z0 * sd;
            }
        }

        // ============================================================
        // DATA GENERATION
        // ============================================================

        function generateData() {
            const scenarioId = document.getElementById('scenario').value;
            const n = parseInt(document.getElementById('n').value);
            const seedInput = document.getElementById('seed').value;

            if (n < 5 || n > 20) {
                alert('Kies een steekproefgrootte tussen 5 en 20');
                return;
            }

            state.scenario = scenarios[scenarioId];
            state.n = n;
            state.seed = seedInput ? parseInt(seedInput) : Math.floor(Math.random() * 999999);

            // Show seed
            document.getElementById('seedValue').textContent = state.seed;
            document.getElementById('seedEcho').classList.remove('hidden');

            // Generate data using seed
            const rng = new SeededRandom(state.seed);
            const targetCorr = state.scenario.correlation;

            // Generate correlated data
            state.data = [];
            let sumX = 0, sumY = 0;

            for (let i = 0; i < n; i++) {
                const z1 = rng.normal(0, 1);
                const z2 = rng.normal(0, 1);

                const x = 50 + 15 * z1;
                const y = 40 + 10 * (targetCorr * z1 + Math.sqrt(1 - targetCorr * targetCorr) * z2);

                state.data.push({
                    id: i + 1,
                    x: Math.max(0, x),
                    y: Math.max(0, y)
                });

                sumX += state.data[i].x;
                sumY += state.data[i].y;
            }

            // Calculate true values
            state.trueValues.meanX = sumX / n;
            state.trueValues.meanY = sumY / n;

            // Calculate deviations
            state.trueValues.deviations = state.data.map(d => ({
                devX: d.x - state.trueValues.meanX,
                devY: d.y - state.trueValues.meanY,
                devX2: Math.pow(d.x - state.trueValues.meanX, 2),
                devY2: Math.pow(d.y - state.trueValues.meanY, 2)
            }));

            // Display everything
            displayVignette();
            displayData();
            showStep1();
        }

        // ============================================================
        // DISPLAY FUNCTIONS
        // ============================================================

        function displayVignette() {
            const vignette = document.getElementById('vignetteCard');
            const text = document.getElementById('vignetteText');

            text.innerHTML = `
                <div class="accent">
                    <h3>${state.scenario.name}</h3>
                    <p style="margin: 10px 0;">${state.scenario.vignette}</p>
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #ccc;">
                    <strong>Kernconcepten:</strong>
                    ${state.scenario.concepts.map(c => `<p style="margin: 5px 0;">${c}</p>`).join('')}
                </div>
            `;

            vignette.classList.remove('hidden');
        }

        function displayData() {
            const card = document.getElementById('dataCard');
            const table = document.getElementById('dataTable');

            document.getElementById('varXLabel').textContent = state.scenario.varXLabel;
            document.getElementById('varYLabel').textContent = state.scenario.varYLabel;

            let html = `
                <thead>
                    <tr>
                        <th>Eenheid</th>
                        <th>X: ${state.scenario.varXLabel}</th>
                        <th>Y: ${state.scenario.varYLabel}</th>
                    </tr>
                </thead>
                <tbody>
            `;

            state.data.forEach(d => {
                html += `
                    <tr>
                        <td>${d.id}</td>
                        <td>${d.x.toFixed(2)}</td>
                        <td>${d.y.toFixed(2)}</td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;
            card.classList.remove('hidden');
        }

        function showStep1() {
            document.getElementById('step1Card').classList.remove('hidden');
            document.getElementById('step2Card').classList.add('hidden');

            // Reset inputs
            document.getElementById('meanX').value = '';
            document.getElementById('meanY').value = '';
            document.getElementById('meanX').classList.remove('valid', 'invalid');
            document.getElementById('meanY').classList.remove('valid', 'invalid');
            document.getElementById('lightMeanX').style.background = '#BDBDBD';
            document.getElementById('lightMeanY').style.background = '#BDBDBD';
            document.getElementById('meansFeedback').innerHTML = '';
        }

        // ============================================================
        // VALIDATION FUNCTIONS
        // ============================================================

        function round4dp(val) {
            return Math.round(val * 10000) / 10000;
        }

        function checkValue(userVal, trueVal, tolerance = 0.0005) {
            const user = parseFloat(userVal);
            const truth = parseFloat(trueVal);

            if (isNaN(user)) return null;

            // Check if rounded values match (4 decimals)
            return round4dp(user) === round4dp(truth);
        }

        function checkMeans() {
            const meanXInput = document.getElementById('meanX');
            const meanYInput = document.getElementById('meanY');
            const lightX = document.getElementById('lightMeanX');
            const lightY = document.getElementById('lightMeanY');
            const feedback = document.getElementById('meansFeedback');

            const meanXVal = meanXInput.value;
            const meanYVal = meanYInput.value;

            const xCorrect = checkValue(meanXVal, state.trueValues.meanX);
            const yCorrect = checkValue(meanYVal, state.trueValues.meanY);

            // Update X
            if (xCorrect === true) {
                meanXInput.classList.remove('invalid');
                meanXInput.classList.add('valid');
                lightX.style.background = '#00C853';
            } else if (xCorrect === false) {
                meanXInput.classList.remove('valid');
                meanXInput.classList.add('invalid');
                lightX.style.background = '#D50000';
            } else {
                meanXInput.classList.remove('valid', 'invalid');
                lightX.style.background = '#BDBDBD';
            }

            // Update Y
            if (yCorrect === true) {
                meanYInput.classList.remove('invalid');
                meanYInput.classList.add('valid');
                lightY.style.background = '#00C853';
            } else if (yCorrect === false) {
                meanYInput.classList.remove('valid');
                meanYInput.classList.add('invalid');
                lightY.style.background = '#D50000';
            } else {
                meanYInput.classList.remove('valid', 'invalid');
                lightY.style.background = '#BDBDBD';
            }

            // Feedback
            if (xCorrect === true && yCorrect === true) {
                feedback.innerHTML = `
                    <div class="feedback ok">
                        ✅ Correct! Beide gemiddelden zijn juist berekend.<br>
                        X̄ = ${round4dp(state.trueValues.meanX).toFixed(4)}<br>
                        Ȳ = ${round4dp(state.trueValues.meanY).toFixed(4)}
                    </div>
                `;
            } else if (xCorrect === false || yCorrect === false) {
                let msg = '❌ Controleer uw berekeningen. ';
                if (xCorrect === false) msg += 'X̄ is niet correct. ';
                if (yCorrect === false) msg += 'Ȳ is niet correct.';
                msg += '<br><br><em>Tip: Som alle waarden en deel door N. Rond af op 4 decimalen.</em>';

                feedback.innerHTML = `<div class="feedback err">${msg}</div>`;
            } else {
                feedback.innerHTML = '';
            }
        }

        function proceedToStep2() {
            const meanXVal = document.getElementById('meanX').value;
            const meanYVal = document.getElementById('meanY').value;

            const xCorrect = checkValue(meanXVal, state.trueValues.meanX);
            const yCorrect = checkValue(meanYVal, state.trueValues.meanY);

            if (xCorrect !== true || yCorrect !== true) {
                alert('Vul eerst de juiste gemiddelden in voordat u verder gaat!');
                return;
            }

            displayStep2();
        }

        function displayStep2() {
            document.getElementById('step2Card').classList.remove('hidden');
            const table = document.getElementById('deviationsTable');

            let html = `
                <thead>
                    <tr>
                        <th>Eenheid</th>
                        <th>X</th>
                        <th>Y</th>
                        <th>(X - X̄)</th>
                        <th>(Y - Ȳ)</th>
                        <th>(X - X̄)²</th>
                        <th>(Y - Ȳ)²</th>
                    </tr>
                </thead>
                <tbody>
            `;

            state.data.forEach((d, i) => {
                const devs = state.trueValues.deviations[i];
                html += `
                    <tr>
                        <td>${d.id}</td>
                        <td>${d.x.toFixed(2)}</td>
                        <td>${d.y.toFixed(2)}</td>
                        <td>${devs.devX.toFixed(4)}</td>
                        <td>${devs.devY.toFixed(4)}</td>
                        <td><input type="number" step="0.0001" class="dev-input" data-row="${i}" data-col="devX2" oninput="checkDeviations()"></td>
                        <td><input type="number" step="0.0001" class="dev-input" data-row="${i}" data-col="devY2" oninput="checkDeviations()"></td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;

            // Create lights
            const lightsDiv = document.getElementById('deviationsLights');
            lightsDiv.innerHTML = '';
            state.data.forEach((d, i) => {
                const light = document.createElement('div');
                light.className = 'light';
                light.id = `lightDev${i}`;
                lightsDiv.appendChild(light);
            });
        }

        function checkDeviations() {
            const inputs = document.querySelectorAll('.dev-input');
            let allCorrect = true;

            inputs.forEach(input => {
                const row = parseInt(input.dataset.row);
                const col = input.dataset.col;
                const trueVal = state.trueValues.deviations[row][col];
                const userVal = input.value;

                const isCorrect = checkValue(userVal, trueVal);

                if (isCorrect === true) {
                    input.classList.remove('invalid');
                    input.classList.add('valid');
                } else if (isCorrect === false) {
                    input.classList.remove('valid');
                    input.classList.add('invalid');
                    allCorrect = false;
                } else {
                    input.classList.remove('valid', 'invalid');
                    allCorrect = false;
                }
            });

            // Update row lights
            for (let i = 0; i < state.data.length; i++) {
                const inputsInRow = document.querySelectorAll(`.dev-input[data-row="${i}"]`);
                const rowCorrect = Array.from(inputsInRow).every(inp => inp.classList.contains('valid'));
                const light = document.getElementById(`lightDev${i}`);

                if (rowCorrect && inputsInRow.length > 0) {
                    light.style.background = '#00C853';
                } else {
                    light.style.background = '#BDBDBD';
                }
            }

            // Feedback
            const feedback = document.getElementById('deviationsFeedback');
            if (allCorrect) {
                feedback.innerHTML = `
                    <div class="feedback ok">
                        ✅ Uitstekend! Alle kwadraten zijn correct berekend.
                    </div>
                `;
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            console.log('Correlatie Prototype geladen');
        });
    </script>
</body>

</html>